<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Reservation Page</title>
  <style>
    .container {
      display: flex;
    }

    .theater-list {
      flex: 1;
    }

    .screen-list {
      flex: 2;
    }

    .theater-item {
      cursor: pointer;
      margin-bottom: 10px;
    }

    .seat-chart {
      display: flex;
      flex-wrap: wrap;
    }

    .seat {
      display: inline-block;
      width: 30px;
      height: 30px;
      margin: 5px;
      text-align: center;
      line-height: 30px;
      cursor: pointer;
    }

    .available {
      background-color: green;
      color: white;
    }

    .unavailable {
      background-color: red;
      color: white;
      cursor: not-allowed;
    }

    .selected {
      background-color: blue;
      color: white;
    }

    #seatChartContainer {
      background-color: #f1f1f1;
      padding: 10px;
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="theater-list">
    <h2>Movie Theaters</h2>
    <ul>
      <li th:each="theater : ${movieTheaters}" class="theater-item" th:onclick="'selectTheater(' + ${theater.theaterId} + ')'">
        <p>Theater Name: <span th:text="${theater.theaterName}"></span></p>
        <p>Theater Location: <span th:text="${theater.theaterLocal}"></span></p>
        <hr>
      </li>
    </ul>
  </div>
  <div class="screen-list">
    <h2>Screens</h2>
    <ul id="screenList">
      <!-- Screens will be dynamically populated here -->
    </ul>
  </div>
</div>
<div id="seatChartContainer">
  <h2>Seat Chart</h2>
  <div id="seatChart"></div>
  <button id="reserveButton" style="display: none">Reserve</button>
</div>
<script th:inline="javascript">
  let selectedSeatIndex = -1;
  let selectedScheduleId = -1;

  function selectTheater(theaterId) {
    // Fetch screens for the selected theater using AJAX
    fetch(`/movies/theaters/${theaterId}/screens`)
            .then(response => response.json())
            .then(data => {
              const screenList = document.getElementById('screenList');
              screenList.innerHTML = '';

              data.forEach(screen => {
                const li = document.createElement('li');
                li.textContent = `Screen Name: ${screen.screenroomName}`;
                screenList.appendChild(li);

                // Fetch schedules for the selected screen using AJAX
                fetch(`/movies/screens/${screen.screenroomId}/schedules`)
                        .then(response => response.json())
                        .then(schedules => {
                          const ul = document.createElement('ul');
                          schedules.filter(schedule => schedule.movieId === /*[[${movieId}]]*/).forEach(schedule => {
                            const scheduleLi = document.createElement('li');
                            scheduleLi.textContent = `Start Time: ${schedule.startTime} / End Time: ${schedule.endTime}`;
                            ul.appendChild(scheduleLi);

                            // Add click event listener to schedule
                            scheduleLi.addEventListener('click', () => {
                              selectedScheduleId = schedule.scheduleId;
                              // Fetch seat status for the selected schedule using AJAX
                              fetch(`/movies/schedules/${schedule.scheduleId}/seatstatus`)
                                      .then(response => response.json())
                                      .then(seatStatus => {
                                        renderSeatChart(seatStatus);
                                      })
                                      .catch(error => console.error(error));
                            });
                          });
                          li.appendChild(ul);
                        })
                        .catch(error => console.error(error));
              });
            })
            .catch(error => console.error(error));
  }

  function renderSeatChart(seatStatus) {
    const seatChartContainer = document.getElementById('seatChartContainer');
    seatChartContainer.style.display = 'block';

    const seatChart = document.getElementById('seatChart');
    seatChart.innerHTML = '';

    const seatChartElement = document.createElement('div');
    seatChartElement.classList.add('seat-chart');

    seatStatus.forEach((isSeatAvailable, seatIndex) => {
      const seatElement = document.createElement('div');
      seatElement.textContent = `Seat ${seatIndex + 1}`;
      seatElement.classList.add('seat');

      if (isSeatAvailable) {
        seatElement.classList.add('available');
      } else {
        seatElement.classList.add('unavailable');
        seatElement.style.cursor = 'not-allowed';
      }

      seatChartElement.appendChild(seatElement);
    });

    seatChart.appendChild(seatChartElement);
    document.getElementById('reserveButton').style.display = 'block';
  }

  // Add click event listener to seatChartContainer
  const seatChartContainer = document.getElementById('seatChartContainer');
  seatChartContainer.addEventListener('click', event => {
    // Check if the clicked element is a seat
    if (event.target.classList.contains('seat')) {
      const selectedSeatElement = event.target;
      const seatIndex = Array.from(selectedSeatElement.parentNode.children).indexOf(selectedSeatElement);

      if (selectedSeatIndex === seatIndex) {
        // Deselect seat
        selectedSeatElement.classList.remove('selected');
        selectedSeatIndex = -1;
      } else {
        // Select seat
        if (selectedSeatIndex !== -1) {
          // Deselect previously selected seat
          const prevSelectedSeatElement = document.querySelector('.seat.selected');
          if (prevSelectedSeatElement) {
            prevSelectedSeatElement.classList.remove('selected');
          }
        }
        selectedSeatElement.classList.add('selected');
        selectedSeatIndex = seatIndex;
      }
    }
  });

  // Add click event listener to reserveButton
  const reserveButton = document.getElementById('reserveButton');
  reserveButton.addEventListener('click', () => {
    // ...

    // Send reservation request to the server using AJAX
    fetch(`/movies/schedules/${selectedScheduleId}/reserve`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        seatNumbers: selectedSeatNumber,
        theaterId: theaterId,
        screenId: screenId,
        userId: userId
      })
    })
            .then(response => {
              // ...
            })
            .catch(error => console.error(error));
  });
</script>
</body>
</html>
